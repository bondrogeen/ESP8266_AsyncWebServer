<!DOCTYPE html>
<html lang="en">

<head>
  //= template/head.html
  <title>Main</title>

  <style>
   
  </style>
</head>

<body>

  //= template/header.html
  <div class="container">
    <div class="row">
      <div class="col-sm-12 col-md-2 col-lg-2">

      </div>
      <div class="col-sm-12 col-md-10 col-lg-9">
        <h2>Main</h2>
        <div class="row">
          <div class="col-sm-12 col-md-10 col-lg-9">
            <table id="table">
              <thead>
                <tr>
                  <th>№</th>
                  <th>Card ID</th>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>

          </div>
        </div>
      </div>
    </div>
  </div>
  //= template/footer.html
  <script>

    var ws;

    var count = 1;
    function getInt(bytes) {
      return bytes.reduce(function (s, e, i) { return s | e << ((3 - i) * 8); }, 0);
    }

    function codeHex2Txt(instr) {
      //    var codeHex = instr.substring(4,6) + instr.substring(2,4) + instr.substring(0,2);
      var codeHex = instr.toUpperCase();
      var l = codeHex.length;
      var codeP1 = codeHex.substring(0, l - 4);
      var codeP2 = codeHex.substring(l - 4);
      var codeP1I = parseInt(codeP1, 16);
      var codeP2I = parseInt(codeP2, 16);

      var codeText = ("000" + codeP1I).slice(-3) + ',' + ("00000" + codeP2I).slice(-5);
      return codeText;
    }


    function codeHex2Dec(instr) {
      //    codeHex = instr.substring(4,6) + instr.substring(2,4) + instr.substring(0,2);
      var codeHex = instr.toUpperCase();
      var codeInt = parseInt(codeHex, 16);
      var codeDec = ("0000000000" + codeInt).slice(-10);
      return codeDec;
    }

    function codeDec2Hex(instr) {
      var codeInt = parseInt(instr, 10);
      var codeHex = codeInt.toString(16);
      var codeHex = ("000000" + codeHex).slice(-6);
      //    codeHex = codeHex.substring(4,6) + codeHex.substring(2,4) + codeHex.substring(0,2);
      return codeHex.toUpperCase();
    }

    function addTable(card, unixTime, state, checksum, isSend) {
      var table = document.getElementById("table");
      var tbody = table.getElementsByTagName("tbody")[0];
      var row = tbody.insertRow(0);
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row.insertCell(2);
      var cell4 = row.insertCell(3);
      var cell5 = row.insertCell(4);

      var userTimezoneOffset = new Date().getTimezoneOffset() * 60;
      d = new Date((unixTime + userTimezoneOffset) * 1000)
      cell1.innerHTML = count;
      cell2.innerHTML = codeHex2Txt(codeDec2Hex(card))
      cell3.innerHTML = d.getDate() + "-" + d.getMonth() + "-" + d.getFullYear() + " " + d.getHours() + ":" + d.getMinutes();
      cell4.innerHTML = (state) ? "Прибыл" : "Убыл";
      cell5.innerHTML = (isSend);
      count++;
    }


    function startEvents() {
      ws = new WebSocket('ws://' + document.location.host + '/ws', ['arduino']);
      ws.binaryType = "arraybuffer";
      
      ws.onopen = function (e) {
        console.log("Connected");
      };
      ws.onclose = function (e) {
        console.log("Disconnected");
      };
      ws.onerror = function (e) {
        console.log("ws error", e);
        console.log("Error");
      };
      ws.onmessage = function (e) {
        var msg = "";
        if (e.data instanceof ArrayBuffer) {
          var bytes = new Uint8Array(e.data);

          var j = 0;
          for (var i = 0; i < bytes.length / 16; i++) {
            var card = getInt([bytes[j+3], bytes[j+2], bytes[j+1], bytes[j+0]]);
            var time = getInt([bytes[j+7], bytes[j+6], bytes[j+5], bytes[j+4]]);
            var fund = getInt([bytes[j+11], bytes[j+10], bytes[j+9], bytes[j+8]]);
            var type = bytes[j+12];
            var send = bytes[j+13];
            var next = bytes[j+14];
            var check = bytes[j+15];

            addTable(card, time, type, check, send);
            console.log(card, time, fund, type, send, next, check);
            j += 16;
          }

        } else {
          msg = "TXT:" + e.data;
          // msg = "LEGHTH:"+e.data.length;
          console.log(msg)
        }
      };
    }

    function load() {
      $("index").classList.add("active");
      startEvents();
    }

    function click(event){
      var id = event.target.id;
      if (id === "reload") {

      } else if (id === "erase") {

      }
      

    }

  </script>
</body>

</html>