<!DOCTYPE html>
<html lang="en">

<head>
  //= template/head.html
  <title>Main</title>

  <style>
    .card .card-image {
      background: url(http://git.codedevice.ru/img/new.jpg) center center / cover no-repeat;
      height: 200px;
      border-bottom: 1px solid
    }

    .card .card-reveal p {
      margin: 0;
    }

    .b {
      font-weight: 700;
    }

    .git,
    .vers,
    .btnInfo,
    .sett {
      position: absolute;
    }

    .btnInfo {
      right: 23px;
      bottom: 50px;
      font-size: 3rem;
      cursor: pointer;
    }

    .sideopen {
      cursor: pointer;
    }

    .git,
    .vers {
      right: 20px;
      bottom: 5px;
    }

    .sett {
      bottom: 30px;
      right: 20px;
    }

    .card .card-content {
      min-height: 115px;
    }
  </style>
</head>

<body>

  //= template/header.html
  <div class="cont">
    <div class="row">
      <div class="s12 m2 l2">

      </div>
      <div class="s12 m10 l-9 ">
        <h2>Main</h2>
        <div class="row">
          <div class="s12 m10 l-9 ">
            <table id="table">
              <thead>
                <tr>
                  <th>№</th>
                  <th>Card ID</th>
                  <th>Time</th>
                  <th>Type</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>

          </div>
        </div>
      </div>
    </div>
  </div>
  //= template/footer.html
  <script>

    var count = 1;
    function getInt(bytes) {
      return bytes.reduce(function (s, e, i) { return s | e << ((3 - i) * 8); }, 0);
    }

    function codeHex2Txt(instr) {
      //    var codeHex = instr.substring(4,6) + instr.substring(2,4) + instr.substring(0,2);
      var codeHex = instr.toUpperCase();
      var l = codeHex.length;
      var codeP1 = codeHex.substring(0, l - 4);
      var codeP2 = codeHex.substring(l - 4);
      var codeP1I = parseInt(codeP1, 16);
      var codeP2I = parseInt(codeP2, 16);

      var codeText = ("000" + codeP1I).slice(-3) + ',' + ("00000" + codeP2I).slice(-5);
      return codeText;
    }


    function codeHex2Dec(instr) {
      //    codeHex = instr.substring(4,6) + instr.substring(2,4) + instr.substring(0,2);
      var codeHex = instr.toUpperCase();
      var codeInt = parseInt(codeHex, 16);
      var codeDec = ("0000000000" + codeInt).slice(-10);
      return codeDec;
    }

    function codeDec2Hex(instr) {
      var codeInt = parseInt(instr, 10);
      var codeHex = codeInt.toString(16);
      var codeHex = ("000000" + codeHex).slice(-6);
      //    codeHex = codeHex.substring(4,6) + codeHex.substring(2,4) + codeHex.substring(0,2);
      return codeHex.toUpperCase();
    }

    function addTable(card, unixTime, state, checksum, isSend) {
      var table = document.getElementById("table");
      var tbody = table.getElementsByTagName("tbody")[0];
      var row = tbody.insertRow(0);
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row.insertCell(2);
      var cell4 = row.insertCell(3);
      var cell5 = row.insertCell(4);

      var userTimezoneOffset = new Date().getTimezoneOffset() * 60;
      d = new Date((unixTime + userTimezoneOffset) * 1000)
      cell1.innerHTML = count;
      cell2.innerHTML = codeHex2Txt(codeDec2Hex(card))
      cell3.innerHTML = d.getDate() + "-" + d.getMonth() + "-" + d.getFullYear() + " " + d.getHours() + ":" + d.getMinutes();
      cell4.innerHTML = (state) ? "Прибыл" : "Убыл";
      cell5.innerHTML = (isSend);
      count++;
    }


    function startEvents() {
      ws = new WebSocket('ws://' + document.location.host + '/ws', ['arduino']);
      ws.binaryType = "arraybuffer";
      ws.onopen = function (e) {
        console.log("Connected");
      };
      ws.onclose = function (e) {
        console.log("Disconnected");
      };
      ws.onerror = function (e) {
        console.log("ws error", e);
        console.log("Error");
      };
      ws.onmessage = function (e) {
        var msg = "";
        if (e.data instanceof ArrayBuffer) {
          var bytes = new Uint8Array(e.data);
          for (var i = 0; i < bytes.length; i++) {
            // console.log(i + ":" + bytes[i])
          }
          var card = getInt([bytes[3], bytes[2], bytes[1], bytes[0]]);
          var unixTime = getInt([bytes[7], bytes[6], bytes[5], bytes[4]]);
          var state = getInt([bytes[11], bytes[10], bytes[9], bytes[8]]);
          var checksum = bytes[12];
          var isSend = bytes[13];
          var any = bytes[14];
          var many = bytes[15];

          addTable(card, unixTime, state, checksum, isSend);
          console.log(card, unixTime, state, checksum, isSend, any, many);
        } else {
          msg = "TXT:" + e.data;
          // msg = "LEGHTH:"+e.data.length;
        }
        console.log(msg);
        console.log(msg.length);
      };
    }

    function load() {
      startEvents();
    }

  </script>
</body>

</html>